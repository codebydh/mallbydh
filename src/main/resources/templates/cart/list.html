<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<th:block layout:fragment="script">
</th:block>

<th:block layout:fragment="css">
    <style>
        .table td, .table th {
            vertical-align: middle;
        }

        .product-info {
            padding: 10px;
        }

        .product-container {
            display: flex;
            align-items: center;
        }

        .product-image {
            margin-right: 15px;
        }

        .product-details {
            flex-grow: 1;
        }

        .product-name {
            margin: 0 0 5px 0;
            font-size: 16px;
        }

        .manufacturer {
            margin: 0 0 5px 0;
            font-size: 14px;
        }

        .product-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</th:block>

<th:block layout:fragment="content">
    <section class="text-center container">
        <div class="row py-lg-5">
            <div class="col-lg-6 col-md-8 mx-auto">
                <h1 class="font-weight-bolder mb-5">장바구니</h1>
            </div>
        </div>
    </section>
    <div class="card-body">
        <div class="mb-2 d-flex justify-content-between align-items-center">
            <div>
                <button type="button" class="btn btn-outline-secondary" id="btnCheckDelete">선택삭제</button>
                <button type="button" class="btn btn-outline-danger" id="btnEmpty">장바구니비우기</button>
            </div>
        </div>
        <table class="table table-bordered">
            <thead class="text-center">
            <tr>
                <th style="width: 5%"><input type="checkbox" id="checkAll"></th>
                <th style="width: 59%">상품정보</th>
                <th style="width: 12%">판매가</th>
                <th style="width: 12%">수량</th>
                <th style="width: 12%">합계</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="item : ${cart_list}">
                <td class="text-center">
                    <input type="checkbox" name="check" th:value="${item['prod_id']}">
                </td>
                <td class="product-info ml-3">
                    <div class="product-container d-flex align-items-center">
                        <div class="product-image me-3" style="width: 81px; height: 81px;">
                            <img th:src="${'/cart/image_display?dateFolderName=' + item.prod_uploadfolder + '&fileName=s_' + item.prod_img}"}
                                 alt="상품 이미지"
                                 class="img-fluid rounded product-thumbnail">
                        </div>
                        <div class="product-details">
                            <h4 class="product-name mb-1" th:text="${item['prod_name']}"></h4>
                            <small class="text-muted"><p class="manufacturer mb-2" th:text="${item['prod_maker']}"></p></small>
                        </div>
                    </div>
                </td>
                <td class="text-center font-weight-bold" style="color: red;" th:text="${#numbers.formatInteger(item['prod_price'], 1, 'COMMA') + '원'}"></td>
                <td class="text-center" th:text="${#numbers.formatInteger(item['cart_amount'], 1, 'COMMA')}"></td>
                <td class="text-center font-weight-bold" style="color: red;" th:text="${#numbers.formatInteger(item['subtotal'], 1, 'COMMA') + '원'}"></td>
            </tr>
            <tr>
                <td colspan="5" class="text-end pe-3 py-3" style="background-color: #DEE2E6;">
                    선택 상품 주문 금액 <span class="fw-bold">총 <span class="text-danger">0</span>원</span>
                </td>
            </tr>
            </tbody>
        </table>
        <div class="my-5 text-center">
            <button type="button" class="btn btn-outline-info">선택상품주문</button>
            <button type="button" class="btn btn-info">전체상품주문</button>
        </div>
    </div>
</th:block>
<th:block layout:fragment="script2">
    <script>
        $(document).ready(function() {
            // 제목행 체크박스 클릭 시 전체 상품 선택
            let isCheck = true;
            $("#checkAll").on("click", function() {
                $("input[name='check']").prop("checked", this.checked);
                isCheck = this.checked;
            });

            // 체크박스가 모두 선택된 상태에서 한 개라도 체크를 해제할 경우 제목행 체크박스 선택도 해제
            $("input[name='check']").on("click", function() {
                $("#checkAll").prop("checked", this.checked);
                $("input[name='check']").each(function() {
                    if(!$(this).is(":checked")) {
                        $("#checkAll").prop("checked", false);
                    }
                });
            });

            // 장바구니 선택상품 삭제
            $("button#btnCheckDelete").on("click", function () {
                if($("input[type='checkbox']:checked").length == 0) {
                    alert("삭제할 상품을 선택해주세요.");
                    return;
                }

                if(confirm("선택한 상품을 삭제하시겠습니까?")) {
                    let checkedItems = $("input[type='checkbox']:checked");
                    let params = checkedItems.map(function() {
                        return "prod_id=" + $(this).val();
                    }).get().join("&");

                    location.href = "/cart/cart_checkdelete?" + params;
                }
            });

            // 장바구니 비우기
            $("button#btnEmpty").on("click", function () {
               if(confirm("장바구니를 비우시겠습니까?")) {
                   location.href = "/cart/cart_empty"
               }
            });
        })

        // 체크박스 선택 시 총액 계산
        function updateTotalPrice() {
            let totalPrice = 0;

            // 체크된 상품들의 합계 계산
            $("tbody input[type='checkbox']:checked").each(function() {
                let row = $(this).closest('tr');
                let subtotal = row.find('td:last').text().replace(/[^0-9]/g, '');
                totalPrice += parseInt(subtotal);
            });

            // 총액 표시 업데이트
            $('.text-end .text-danger').text(totalPrice.toLocaleString());
        }

        // 체크박스 이벤트 리스너
        $("input[type='checkbox']").on('change', function() {
            updateTotalPrice();
        });

        // 전체선택 체크박스
        $("#checkAll").on('change', function() {
            $("tbody input[type='checkbox']").prop('checked', $(this).prop('checked'));
            updateTotalPrice();
        });
    </script>
</th:block>
</html>